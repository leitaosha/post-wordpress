---
title: WordPress添加钉钉机器人评论通知
wpPostStatus: draft
wpCategory: Python
wpComment: True
tags:
 - 钉钉机器人
 - WordPress
 - 评论通知
description: 
wp:
    wpLink: https://blog.leitaosha.top
    wpCategoryId: 123
    wpPostId: 12
    wpProfileName: slt
    wpPostType: niaho
---
## 摘要

在使用 wordpress 中，有很多种方法通知评论。例如，邮件、机器人等。其中钉钉机器人通知无疑是一个非常棒的选择。通知的界面和功能比邮件具有更好的呈现形式，而且可以随时通过屏蔽群消息而关掉。很多工具也已经接入了钉钉机器人通知。本文以[盒子萌](https://www.boxmoe.com/611.html)提供的代码为基础进行修改，为大家带来更具简洁的通知界面和快捷的操作方式。
![](https://s2.loli.net/2024/04/15/3MTQLBONvsVrRXz.jpg) ![](https://s2.loli.net/2024/04/15/qjkYABQXcoVuFbr.jpg)


## 代码实现

话不多说，在 wordpress 根路径种打开 `wp-content --> themes --> <你的主题名> --> functions.php ` 中添加如下代码：

```php
// 钉钉机器人通知
function request_by_curl($remote_server, $post_string) {  
    $ch = curl_init();  
    curl_setopt($ch, CURLOPT_URL, $remote_server);
    curl_setopt($ch, CURLOPT_POST, 1); 
    curl_setopt($ch, CURLOPT_CONNECTTIMEOUT, 5); 
    curl_setopt($ch, CURLOPT_HTTPHEADER, array ('Content-Type: application/json;charset=utf-8'));
    curl_setopt($ch, CURLOPT_POSTFIELDS, $post_string);  
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);  
    curl_setopt ($ch, CURLOPT_SSL_VERIFYHOST, 0); 
    curl_setopt ($ch, CURLOPT_SSL_VERIFYPEER, 0);
    $data = curl_exec($ch);
    curl_close($ch);                
    return $data;  
}
function msg_ding_comment($comment_id){
	// 修改secret 共以下两个地方
	$secret  = '你的机器人key';
	$sign    = urlencode(base64_encode(hash_hmac('sha256', "{$time}\n{$secret}", $secret, true)));
	// 修改机器人URL
	$apiurl	 = 'https://oapi.dingtalk.com/robot/send?access_token=你的机器人TOKEN&timestamp='.$time.'&sign='.$sign.'';
    $comment = get_comment($comment_id);
    $parent_id = $comment->comment_parent ? $comment->comment_parent : "";
    $siteurl = get_bloginfo('url');
    // 标题
    $title_c = '《' . get_the_title($comment->comment_post_ID) . '》有新评论！';
    // 状态
    $status_c = $comment->comment_approved ? '已审核' : "未审核";
    // 是否回复评论
    $parent_c = $parent_id ? get_comment($parent_id)->comment_content : '';
    $parent_a = $parent_id ? get_comment($parent_id)->comment_author : '';
    if($parent_id){
        $commet_c = $comment->comment_content . "  (Re > " . $parent_a . "：$parent_c)";
    }else{
        $commet_c = $comment->comment_content;
    }
    // 信息拼接
    $info_c = "#### **$title_c**\n\n**昵称**: $comment->comment_author \n\n**邮箱**: $comment->comment_author_email \n\n**状态**：***$status_c***\n\n**评论**: $commet_c";
    // 按钮点击链接
    $look_c = "$siteurl/?p=$comment->comment_post_ID#comments";
    $agree_c = "$siteurl/wp-admin/comment.php?action=approve&c=$comment_id#wpbody-cotent";
    $trash_c = "$siteurl/wp-admin/comment.php?action=spam&c=$comment_id#wpbody-cotent";
    $edit_c = "$siteurl/wp-admin/comment.php?action=editcomment&c=$comment_id";
    $move_trash="$siteurl/wp-admin/comment.php?action=trash&c=$comment_id#wpbody-cotent";
	$time    = intval(microtime(true) * 1000);
    // 审核是否通过对应不同按钮
    $re_edit=$comment->comment_approved ? "{'title':'编辑','actionURL':'$edit_c'}," : "{'title':'审核','actionURL':'$agree_c'},";
	$data = "{
	    'msgtype': 'actionCard',
	    'actionCard': {
	        'title':'$title_c',
	        'text':'$info_c',
	        'btnOrientation':'0',
	        'btns':[{
	            'title':'查看',
	            'actionURL':'$look_c'
	        },
            $re_edit
	        {
	            'title':'标记垃圾',
	            'actionURL':'$trash_c'
	        },
	        {
	            'title':'移动到回收站',
	            'actionURL':'$move_trash'
	        },]
	    }
	}";
	return $result = request_by_curl($apiurl, $data);  	
	}
add_action('comment_post', 'msg_ding_comment', 19, 2);	
```

